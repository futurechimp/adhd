#!/usr/bin/env ruby
require File.dirname(__FILE__) + '/../lib/ext/hash_to_openstruct'
require File.dirname(__FILE__) + '/../lib/adhd/node_manager'
require File.dirname(__FILE__) + '/../lib/adhd/reactor'
require File.dirname(__FILE__) + '/../lib/adhd/adhd_rest_server'

require 'optparse'
require 'ftools'
require 'yaml'
# require 'socket'

def parse_config(file)
  @config = YAML.load_openstruct(File.read(file))
end

# @command = ARGV.shift

#options = {}

opts = OptionParser.new do |opts|
  opts.on("-c", "--config C", "YAML config file") do |n|
    puts "Parsing config file #{n}"
    parse_config(n)
  end
end

opts.parse! ARGV

@node_manager = Adhd::NodeManager.new(@config)


# Start the Thin server within the reactor loop

EM.run {
  # puts "Starting EventMachine reactor loop..."
  # EM.connect @config.node_url, @config.couchdb_server_port, Adhd::DbUpdateNotifier, @node_manager
  timer = EventMachine::PeriodicTimer.new(5) do
    # puts "Sync Admin"
    @node_manager.sync_admin
    @node_manager.run
  end
  
  
  # Start the server
  EventMachine::start_server @config.node_url, @config.http_server_port, AdhdRESTServer, @node_manager
  

  
}

