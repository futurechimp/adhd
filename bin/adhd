#!/usr/bin/env ruby
require File.dirname(__FILE__) + '/../lib/ext/hash_to_openstruct'
require File.dirname(__FILE__) + '/../lib/adhd/node'
require File.dirname(__FILE__) + '/../lib/adhd/reactor'

require 'optparse'
require 'ftools'
require 'yaml'
require 'socket'

def parse_config(file)
  @config = YAML.load_openstruct(File.read(file))
end

@command = ARGV.shift

options = {}

opts = OptionParser.new do |opts|
  opts.on("-C", "--config C", "YAML config file") do |n|
    parse_config(n)
  end
end

opts.parse! ARGV

@node = Adhd::Node.new(@config)

EM.run {
  puts "Starting EventMachine reactor loop..."
  EM.connect @config.node_url, @config.couchdb_server_port, Adhd::DbUpdateReactor, @node
}

